sudo su
yum update -y

wget -r --no-parent -A 'epel-release-*.rpm' https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/
rpm -Uvh dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-*.rpm
yum-config-manager --enable epel*
amazon-linux-extras install epel -y

yum install -y docker certbot python2-certbot-apache httpd-tools
service docker start
usermod -aG docker ec2-user
docker pull registry

service httpd stop
certbot certonly --standalone --non-interactive --agree-tos -m ${email} -d ${instanceIpv4}.nip.io

cd /etc/letsencrypt/live/${instanceIpv4}.nip.io/
cp privkey.pem domain.key
cat cert.pem chain.pem > domain.crt
chmod 777 domain.crt
chmod 777 domain.key

cd
mkdir auth

htpasswd -Bbn onedep ${registryPassword} > auth/htpasswd

docker run -d -p 5000:5000 --restart=always --name registry \
  -v /etc/letsencrypt/live/${instanceIpv4}.nip.io:/certs \
  -v /opt/docker-registry:/var/lib/registry \
  -v `pwd`/auth:/auth \
  -e "REGISTRY_AUTH=htpasswd" \
  -e "REGISTRY_AUTH_HTPASSWD_REALM=OneDep Docker Registry" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2

docker login ${instanceIpv4}.nip.io:5000 -u onedep -p ${registryPassword}
exit
exit
